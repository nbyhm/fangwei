<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="edge" />
    <title>NOAH权限管理系统</title>
    <link rel="shortcut icon" type="image/png" th:href="@{/favicon.ico}" />
    <script th:src="@{js/jquery.min.js}"></script>
</head>
<style>

</style>
<body style="text-align: center">
<!-- Form-->
<div class="form">
    <div class="form-toggle"></div>
    <div class="form-panel one">
        <div class="form-header">
            <h1>账户登录</h1>
        </div>
        <div class="form-content">
            <div class="form-group">
                <label>用户名</label>
                <input type="text" name="username" />
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" name="password" />
            </div>
            <div class="form-group" style="display:inline-block">
                <label>验证码</label>
                <input type="text" name="code" style="width:50%; display:inline-block" />
                <img data-th-src="@{gifCode}" id="validateCodeImg" onclick="reloadCode()" style="display:inline-block" />
            </div>
            <div class="form-group" style="margin: 0px;">
                <p>
                    <input type="checkbox" name="rememberme" />&nbsp;&nbsp;记住我</p>
            </div>
            <div class="form-group">
                <button onclick="login()" id="loginButton">登录</button>
            </div>
        </div>
    </div>
    <div class="form-panel two">
        <div class="form-header">
            <h1>账户注册</h1>
        </div>
        <div class="form-content">
            <div class="form-group">
                <label>手机号</label>
                <input type="text" name="mobile" />
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" name="password" />
            </div>
            <div class="form-group">
                <label>确认密码</label>
                <input type="password" name="cpassword" />
            </div>
            <div class="form-group">
                <button onclick="regist()">注册</button>
            </div>
        </div>
    </div>
</div>
<div data-th-include="common/footer"></div>
</body>
<script th:inline="javascript">
    var setHost = "api";
    var ctx = [[@{/}]];
</script>
<!--<script data-th-src="@{js/app/login.js}"></script>-->
<script>
    $(document).ready(function () {

        $('input').iCheck({
            checkboxClass: 'icheckbox_minimal-green',
            radioClass: 'iradio_minimal-green',
            increaseArea: '20%'
        });

        var $formPanelTwo = $('.form-panel.two');

        var panelOne = $formPanelTwo.height();
        var panelTwo = $formPanelTwo[0].scrollHeight;

        $formPanelTwo.not('.form-panel.two.active').on('click', function (e) {
            e.preventDefault();

            $('.form-toggle').addClass('visible');
            $('.form-panel.one').addClass('hidden');
            $('.form-panel.two').addClass('active');
            $('.form').animate({
                'height': panelTwo
            }, 200);
        });

        $('.form-toggle').on('click', function (e) {
            e.preventDefault();
            $(this).removeClass('visible');
            $('.form-panel.one').removeClass('hidden');
            $('.form-panel.two').removeClass('active');
            $('.form').animate({
                'height': panelOne + 92
            }, 200);
        });

    });


    function reloadCode() {
        $("#validateCodeImg").attr("src", ctx + "gifCode?data=" + new Date() + "");
    }

    function login() {
        var username = $(".one input[name='username']").val().trim();
        var password = $(".one input[name='password']").val().trim();
        var code = $(".one input[name='code']").val().trim();
        var rememberMe = $(".one input[name='rememberme']").is(':checked');
        if (username === "") {
            $MB.n_warning("请输入用户名！");
            return;
        }
        if (password === "") {
            $MB.n_warning("请输入密码！");
            return;
        }
        if (code === "") {
            $MB.n_warning("请输入验证码！");
            return;
        }

        $.ajax({
            type: "post",
            url: ctx + "/api/login",
            data: {
                "username": username,
                "password": password,
                "code": code,
                "rememberMe": rememberMe
            },
            dataType: "json",
            success: function (r) {
                if (r.code === 200) {
                    location.href = ctx + 'index';
                } else {
                    reloadCode();
                    $MB.n_warning(r.msg);
                    $loginButton.html("登录");
                }
            }
        });
    }

    function regist() {
        var mobile = $(".two input[name='mobile']").val().trim();
        var password = $(".two input[name='password']").val().trim();
        var cpassword = $(".two input[name='cpassword']").val().trim();
        if (mobile === "") {
            $MB.n_warning("用户名不能为空！");
            return;
        } else if (mobile.length > 10) {
            $MB.n_warning("用户名长度不能超过10个字符！");
            return;
        } else if (mobile.length < 3) {
            $MB.n_warning("用户名长度不能少于3个字符！");
            return;
        }
        if (password === "") {
            $MB.n_warning("密码不能为空！");
            return;
        }
        if (cpassword === "") {
            $MB.n_warning("请再次输入密码！");
            return;
        }
        if (cpassword !== password) {
            $MB.n_warning("两次密码输入不一致！");
            return;
        }
        $.ajax({
            type: "post",
            url: ctx + "api/register",
            data: {
                "mobile": mobile,
                "password": password
            },
            dataType: "json",
            success: function (r) {
                if (r.code === 200) {
                    $MB.n_success("注册成功，请登录");
                    $(".two input[name='mobile']").val("");
                    $(".two input[name='password']").val("");
                    $(".two input[name='cpassword']").val("");
                    $('.form-toggle').trigger('click');
                } else {
                    $MB.n_warning(r.msg);
                }
            }
        });
    }

    document.onkeyup = function (e) {
        if (window.event)
            e = window.event;
        var code = e.charCode || e.keyCode;
        if (code === 13) {
            login();
        }
    };
</script>
</html>